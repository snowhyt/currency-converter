import express from "express";
const wrapper = async (handler, converter) => {
    const app = express();
    // To serve static assets
    app.use(express.static("../../assets"));
    const imageHandlerPath = "../../image-optimization-function/index.mjs";
    const imageHandler = await import(imageHandlerPath).then((m) => m.handler);
    app.all("/_next/image", async (req, res) => {
        const internalEvent = await converter.convertFrom(req);
        const streamCreator = {
            writeHeaders: (prelude) => {
                res.writeHead(prelude.statusCode, prelude.headers);
                return res;
            },
        };
        await imageHandler(internalEvent, { streamCreator });
    });
    app.all("*paths", async (req, res) => {
        const internalEvent = await converter.convertFrom(req);
        const streamCreator = {
            writeHeaders: (prelude) => {
                res.writeHead(prelude.statusCode, prelude.headers);
                return res;
            },
            onFinish: () => { },
        };
        await handler(internalEvent, { streamCreator });
    });
    const server = app.listen(Number.parseInt(process.env.PORT ?? "3000", 10), () => {
        console.log(`Server running on port ${process.env.PORT ?? 3000}`);
    });
    app.on("error", (err) => {
        console.error("error", err);
    });
    return () => {
        server.close();
    };
};
export default {
    wrapper,
    name: "expresss-dev",
    supportStreaming: true,
};
